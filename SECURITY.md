# Security Best Practices

## Overview

This document explains how secrets are handled securely in this project and answers common security concerns.

---

## Secrets Management

### What Goes in GitHub âœ…

**Safe to commit:**
```yaml
# render.yaml
envVars:
  - key: SECRET_KEY
    generateValue: true     # â† Safe: Just an instruction
  
  - key: DATABASE_URL
    fromDatabase:           # â† Safe: Reference, not actual value
      name: ip-tracking-db
  
  - key: ALLOWED_HOSTS
    sync: false             # â† Safe: Tells Render to ask for value
```

**These are just instructions - NO actual secrets!**

---

### What NEVER Goes in GitHub âŒ

**NEVER commit these:**
```python
# âŒ WRONG - Don't do this!
SECRET_KEY = 'my-actual-secret-key-12345'
DATABASE_URL = 'postgresql://user:password@host/db'
REDIS_URL = 'redis://:password@host:6379'
```

**NEVER commit these files:**
- `.env` (actual environment variables)
- `db.sqlite3` (contains data)
- `*.pyc` (compiled Python files)
- `__pycache__/` (Python cache)
- `staticfiles/` (collected static files)

---

## How Render Keeps Secrets Safe

### 1. Environment Variables Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Your GitHub Repository                  â”‚
â”‚                                                   â”‚
â”‚  render.yaml (PUBLIC)                            â”‚
â”‚  â”œâ”€â”€ generateValue: true  â† Instruction only    â”‚
â”‚  â””â”€â”€ sync: false          â† Placeholder         â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Render Platform (SECURE)                 â”‚
â”‚                                                   â”‚
â”‚  Environment Variables (ENCRYPTED)               â”‚
â”‚  â”œâ”€â”€ SECRET_KEY: "xK9m...jK0l"  â† Actual value  â”‚
â”‚  â”œâ”€â”€ DATABASE_URL: "postgresql://..."           â”‚
â”‚  â””â”€â”€ REDIS_URL: "redis://..."                   â”‚
â”‚                                                   â”‚
â”‚  âœ… Only accessible via Render Dashboard         â”‚
â”‚  âœ… Never exposed in logs or GitHub              â”‚
â”‚  âœ… Encrypted at rest                            â”‚
â”‚  âœ… Injected at runtime only                     â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Secret Generation Methods

#### Option A: Auto-Generate (Recommended)
```yaml
- key: SECRET_KEY
  generateValue: true
```
- âœ… Render creates a cryptographically secure random value
- âœ… Never visible in GitHub
- âœ… Automatically synced across services

#### Option B: Manual Entry
```yaml
- key: ALLOWED_HOSTS
  sync: false
```
- âœ… Render prompts you during deployment
- âœ… Value stored encrypted in Render
- âœ… Never appears in YAML file

#### Option C: Reference Another Service
```yaml
- key: SECRET_KEY
  fromService:
    type: web
    name: ip-tracking-web
    envVarKey: SECRET_KEY
```
- âœ… Automatically copies value from another service
- âœ… Ensures consistency across services
- âœ… No manual copying needed

---

## Current Project Configuration

### SECRET_KEY Management

**Web Service (ip-tracking-web):**
```yaml
- key: SECRET_KEY
  generateValue: true  # Render generates secure random key
```

**Celery Workers (auto-synced):**
```yaml
- key: SECRET_KEY
  fromService:
    type: web
    name: ip-tracking-web
    envVarKey: SECRET_KEY  # Copies from web service
```

**Result:** All services use the same SECRET_KEY, but it's NEVER in GitHub!

---

## Security Checklist

### âœ… What's Protected

- [x] **SECRET_KEY** - Auto-generated by Render
- [x] **DATABASE_URL** - Auto-configured by Render PostgreSQL
- [x] **REDIS_URL** - Auto-configured by Render Key Value
- [x] **Environment variables** - Encrypted in Render
- [x] **No secrets in git history** - Clean repository

### âš ï¸ What You Need to Manage

- [ ] **ALLOWED_HOSTS** - Add your Render URL after deployment
- [ ] **Admin password** - Create strong superuser password
- [ ] **Database backups** - Set up regular backups (production)
- [ ] **Access logs** - Monitor for suspicious activity

---

## Common Security Questions

### Q: "Can anyone see my SECRET_KEY on GitHub?"

**A:** No! The `render.yaml` file only contains instructions like `generateValue: true`. The actual secret is generated by Render and stored encrypted.

### Q: "What if I accidentally commit a secret?"

**A:** If you accidentally commit a real secret:

1. **Immediately rotate the secret**
   - Go to Render Dashboard â†’ Service â†’ Environment
   - Change the value
   - Save (triggers redeploy)

2. **Remove from git history**
   ```bash
   # Remove the file containing secrets
   git filter-branch --force --index-filter \
     'git rm --cached --ignore-unmatch .env' \
     --prune-empty --tag-name-filter cat -- --all
   
   # Force push (careful!)
   git push origin --force --all
   ```

3. **Better: Use BFG Repo-Cleaner**
   ```bash
   # Download BFG
   # https://rtyley.github.io/bfg-repo-cleaner/
   
   # Remove secrets file
   bfg --delete-files .env
   
   # Clean up
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

### Q: "How do I use environment variables locally?"

**A:** Create a `.env` file (which is gitignored):

1. **Create `.env` file:**
   ```bash
   # ip_tracking_project/.env
   SECRET_KEY=your-local-dev-key-12345
   DEBUG=True
   DATABASE_URL=sqlite:///db.sqlite3
   REDIS_URL=redis://localhost:6379/0
   ALLOWED_HOSTS=localhost,127.0.0.1
   ```

2. **Install python-decouple:**
   ```bash
   pip install python-decouple
   ```

3. **Update settings.py:**
   ```python
   from decouple import config
   
   SECRET_KEY = config('SECRET_KEY')
   DEBUG = config('DEBUG', default=False, cast=bool)
   ```

4. **Verify .env is gitignored:**
   ```bash
   # .gitignore should have:
   .env
   *.env
   .env.*
   ```

---

## Production Security Settings

### Enabled Automatically (when DEBUG=False)

```python
# From settings.py
if not DEBUG:
    SECURE_SSL_REDIRECT = True           # Force HTTPS
    SESSION_COOKIE_SECURE = True         # HTTPS-only cookies
    CSRF_COOKIE_SECURE = True            # HTTPS-only CSRF
    SECURE_HSTS_SECONDS = 31536000       # 1 year HSTS
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    X_FRAME_OPTIONS = 'DENY'             # Prevent clickjacking
    SECURE_BROWSER_XSS_FILTER = True     # XSS protection
    SECURE_CONTENT_TYPE_NOSNIFF = True   # MIME sniffing protection
```

### Additional Recommendations

1. **Strong Admin Password**
   ```bash
   python manage.py createsuperuser
   # Use password manager to generate strong password
   ```

2. **Regular Updates**
   ```bash
   pip list --outdated
   pip install --upgrade django
   pip install --upgrade djangorestframework
   ```

3. **Security Scanning**
   ```bash
   pip install safety
   safety check
   ```

4. **Database Backups**
   - Render PostgreSQL: Enable automatic backups (paid plans)
   - Or use `pg_dump` for manual backups

---

## What Render Shows You

### Dashboard â†’ Service â†’ Environment Tab

You'll see:
```
SECRET_KEY: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢  (hidden)
DATABASE_URL: postgres://â€¢â€¢â€¢â€¢  (hidden)
ALLOWED_HOSTS: your-app.onrender.com  (visible - not sensitive)
```

**Click "Show" to reveal values** - but they're never in GitHub!

---

## Incident Response

### If You Suspect a Breach

1. **Rotate all secrets immediately**
   - SECRET_KEY
   - Database password
   - Redis password

2. **Check logs for suspicious activity**
   ```bash
   # In Render Shell
   python manage.py shell
   from ip_tracking.models import RequestLog, SuspiciousIP
   
   # Check recent suspicious IPs
   SuspiciousIP.objects.filter(
       flagged_at__gte='2026-01-01'
   ).order_by('-flagged_at')
   ```

3. **Review admin access logs**
   - Check Django admin access logs
   - Review Render activity logs

4. **Force logout all users**
   ```bash
   python manage.py clearsessions
   ```

---

## Best Practices Summary

### âœ… DO:
- Use `generateValue: true` for secrets in render.yaml
- Keep `.env` in `.gitignore`
- Use strong, unique passwords
- Enable 2FA on Render account
- Regularly update dependencies
- Monitor suspicious activity
- Use HTTPS in production
- Rotate secrets periodically

### âŒ DON'T:
- Commit `.env` files to git
- Share secrets via email or chat
- Use default or weak passwords
- Disable security features in production
- Ignore security warnings
- Reuse passwords across services
- Commit debug logs with sensitive data

---

## Verification

### Check Your Repository is Clean

```bash
# Check no secrets in current files
git grep -i "secret.*=" | grep -v "generateValue"
git grep -i "password.*=" | grep -v "validators"
git grep -i "api.*key.*="

# Check git history for .env files
git log --all --full-history -- .env

# If found, clean it up immediately!
```

### Verify .gitignore

```bash
# Check .gitignore includes:
cat .gitignore | grep -E "\.env|db\.sqlite3|__pycache__|*.pyc"
```

---

## Additional Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Django Security Docs](https://docs.djangoproject.com/en/5.0/topics/security/)
- [Render Security](https://render.com/docs/security)
- [Mozilla Web Security Guidelines](https://infosec.mozilla.org/guidelines/web_security)

---

## Contact

If you discover a security vulnerability:

1. **DO NOT** open a public issue
2. Email: [your-security-email]
3. Or report via GitHub Security Advisory

---

**Remember: Security is a process, not a product. Stay vigilant!** ğŸ”’
